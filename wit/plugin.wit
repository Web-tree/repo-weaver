package weaver:plugin;

interface secrets {
    record secret-request {
        key: string,
    }

    variant secret-error {
        access-denied(string),
        not-found(string),
        internal(string),
    }

    get-secret: func(req: secret-request) -> result<string, secret-error>;
}

interface process {
    record exec-request {
        program: string,
        args: list<string>,
        cwd: option<string>,
        env: list<tuple<string, string>>,
        inherit-env: bool,
        stdin: option<list<u8>>,
    }

    record exec-result {
        status: u32,
        stdout: list<u8>,
        stderr: list<u8>,
    }

    exec: func(req: exec-request) -> result<exec-result, string>;
}

world provider {
    import process;
    export secrets;
}

// Ensure plugin interface
interface ensures {
    record ensure-request {
        app-path: string,
        dry-run: bool,
        config: string,  // JSON-serialized ensure config
    }

    record ensure-plan {
        description: string,
        actions: list<string>,
    }

    variant ensure-error {
        config-error(string),
        execution-error(string),
        not-applicable(string),
    }

    plan: func(req: ensure-request) -> result<ensure-plan, ensure-error>;
    execute: func(req: ensure-request) -> result<string, ensure-error>;
}

world ensure-provider {
    import process;
    export ensures;
}

