# Implementation Plan: Gap Analysis

**Branch**: `002-gap-analysis` | **Date**: 2026-01-03 | **Spec**: [spec.md](file:///Users/max/git/webtree/repo-weaver/specs/002-gap-analysis/spec.md)  
**Input**: Feature specification from `/specs/002-gap-analysis/spec.md`

## Summary

Implement the remaining MVP features identified in the gap analysis between PRD §12 and 001-repo-weaver-mvp. Key additions include:
- YAML includes/merging for modular config (P1)
- CLI discovery commands: `list`, `describe`, `check` (P1/P2)
- Git ensure types: `git.submodule`, `git.clone_pinned` (P1)
- Module management commands (P2)
- npm.script and ai.patch ensures (P2/P3)

## Technical Context

**Language/Version**: Rust 2024 Edition (edition = "2024")  
**Primary Dependencies**: serde, serde_yml, clap (4.5), tera (1.19), wasmtime (18.0), walkdir  
**Storage**: YAML files (weaver.yaml, .rw/state.yaml, .rw/answers.yaml)  
**Testing**: cargo test, integration tests with assert_cmd + tempfile  
**Target Platform**: macOS/Linux CLI, single binary  
**Project Type**: Single Rust workspace with crates (cli, core, ops)  
**Performance Goals**: Commands complete <2s, k3s-nebula bootstrap <30s  
**Constraints**: No external runtime dependencies beyond git, npm (for npm.script)  
**Scale/Scope**: 10+ apps per workspace, 10+ include fragments

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Declarative Desired State | ✅ PASS | YAML defines target state |
| II. Native Tool First | ✅ PASS | Using git CLI, npm CLI - no custom parsers |
| III. Composition and Reuse | ✅ PASS | Includes enable modular configs |
| IV. Idempotency & Determinism | ✅ PASS | Ensures are idempotent, merge order is deterministic |
| V. Update Safety | ✅ PASS | Dirty tree detection prevents data loss |
| VI. Secret Decoupling | ✅ PASS | No secrets in config, provider-based resolution |

## Project Structure

### Documentation (this feature)

```text
specs/002-gap-analysis/
├── plan.md              # This file
├── research.md          # Phase 0 research decisions
├── data-model.md        # Entity definitions
├── quickstart.md        # Quick reference
├── contracts/           # CLI contract definitions
│   ├── cli-list.md      # rw list output format
│   ├── cli-describe.md  # rw describe output format
│   └── cli-module.md    # rw module subcommands
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code Structure

```text
crates/
├── cli/
│   ├── src/
│   │   ├── commands/
│   │   │   ├── apply.rs        # [MODIFY] Add ensure dispatcher
│   │   │   ├── list.rs         # [NEW] Discovery command
│   │   │   ├── describe.rs     # [NEW] App inspection
│   │   │   ├── check.rs        # [NEW] Validation runner
│   │   │   ├── module.rs       # [NEW] Module management
│   │   │   └── mod.rs          # [MODIFY] Register new commands
│   │   └── main.rs             # [MODIFY] Add new subcommands
│   └── tests/integration/
│       ├── list.rs             # [NEW] List command tests
│       └── includes.rs         # [NEW] Include merge tests
├── core/
│   ├── src/
│   │   ├── config.rs           # [MODIFY] Add includes, checks fields
│   │   ├── config/
│   │   │   └── loader.rs       # [NEW] Include loader with merge
│   │   ├── ensure.rs           # [NEW] Ensure trait
│   │   ├── ensure/
│   │   │   ├── mod.rs          # [NEW] Type registry
│   │   │   ├── git.rs          # [NEW] Git ensure implementations
│   │   │   ├── npm.rs          # [NEW] npm.script ensure
│   │   │   └── ai.rs           # [NEW] ai.patch ensure
│   │   └── lib.rs              # [MODIFY] Export new modules
│   └── tests/                  # [TBD] Unit tests for merge logic
└── ops/
    └── src/
        ├── git.rs              # [MODIFY] Add submodule functions
        └── npm.rs              # [NEW] npm pkg set wrapper
```

---

## Proposed Changes

### Core: Config Loader with Includes

#### [MODIFY] [config.rs](file:///Users/max/git/webtree/repo-weaver/crates/core/src/config.rs)

Add `includes` field to `WeaverConfig`:
```rust
pub struct WeaverConfig {
    pub version: String,
    #[serde(default)]
    pub includes: Vec<String>,  // NEW
    #[serde(default)]
    pub modules: Vec<ModuleConfig>,
    // ...
}
```

#### [NEW] config/loader.rs

New module implementing:
- `load_with_includes(path: &Path) -> Result<WeaverConfig>` - entry point
- `expand_includes(patterns: &[String], base: &Path) -> Result<Vec<PathBuf>>` - glob expansion
- `merge_configs(base: Value, overlay: Value) -> Value` - deep merge algorithm

---

### Core: Ensure Trait Abstraction

#### [NEW] ensure.rs

```rust
pub trait Ensure: Send + Sync {
    fn plan(&self, ctx: &EnsureContext) -> Result<EnsurePlan>;
    fn execute(&self, ctx: &EnsureContext) -> Result<()>;
}

pub struct EnsureContext {
    pub app_path: PathBuf,
    pub dry_run: bool,
    pub state: State,
}
```

#### [NEW] ensure/git.rs

Implementations for:
- `EnsureGitSubmodule` - git submodule add/update with dirty check
- `EnsureGitClonePinned` - git clone with ref checkout

---

### CLI: New Commands

#### [NEW] commands/list.rs

Output format:
```
APPS:
  my-app          ./apps/my-app       (module: k3s-nebula@v1.0.0)
  other-app       ./apps/other        (module: base@main)

TASKS:
  my-app:install  Run installation pipeline
  my-app:plan     Preview terraform changes
```

#### [NEW] commands/describe.rs

Shows fully resolved app config with secrets redacted as `***`.

#### [NEW] commands/module.rs

Subcommands:
- `rw module list` - show modules with source/ref
- `rw module update <name> --ref <ref>` - update ref in weaver.yaml

---

### Ops: Extended Git Operations

#### [MODIFY] [git.rs](file:///Users/max/git/webtree/repo-weaver/crates/ops/src/git.rs)

Add functions:
- `is_worktree_clean(path: &Path) -> Result<bool>`
- `submodule_add(url: &str, path: &Path, ref_: &str) -> Result<()>`
- `submodule_update(path: &Path, ref_: &str) -> Result<()>`

---

## Verification Plan

### Automated Tests

**Unit Tests** (cargo test):
```bash
cargo test --workspace
```

Tests to add:
- `crates/core/src/config/loader.rs` - merge algorithm tests
- `crates/core/src/ensure/git.rs` - dirty tree detection tests

**Integration Tests**:
```bash
cargo test --package repo-weaver-cli --test integration
```

Tests to add in `crates/cli/tests/integration/`:
- `includes.rs` - test include glob expansion and merge
- `list.rs` - test list command output format
- `git_ensure.rs` - test git.submodule ensure with mock remote

### Manual Verification

1. **Includes Merge**:
   - Create test workspace with `weaver.yaml` containing `includes: ["weaver.d/*.yaml"]`
   - Add fragment file `weaver.d/app1.yaml` with app definition
   - Run `rw list` and verify app appears

2. **Git Submodule**:
   - Create config with `ensure.git.submodule` definition
   - Run `rw apply` and verify submodule is initialized
   - Modify file in submodule, run `rw apply` - should fail with dirty tree error

3. **k3s-nebula Validation** (PRD §14):
   - Empty folder + k3s-nebula module config
   - `rw apply` generates Taskfile + tfvars
   - User runs `rw run app install` to execute pipeline

---

## Implementation Priority

| Phase | Features | Effort |
|-------|----------|--------|
| 1 | Includes merge, `rw list` | 2-3 days |
| 2 | git.submodule, git.clone_pinned | 2 days |
| 3 | `rw describe`, `rw check` | 1-2 days |
| 4 | `rw module *` commands | 1 day |
| 5 | npm.script ensure | 1 day |
| 6 | ai.patch ensure | 2-3 days |
